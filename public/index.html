<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI + SEO + Schema Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="title">
      <h1>AI • SEO • Schema Analyzer</h1>
      <small class="muted">AEO / GEO / Schema.org / OpenGraph / robots / llms / ai</small>
    </div>

    <div class="input-card">
      <div class="row">
        <input id="urlInput" type="url" placeholder="Enter a URL e.g. https://example.com/page" />
        <button id="analyzeBtn">Analyze</button>
      </div>
      <div id="loading" class="muted">Analyzing…</div>
      <div id="error" class="muted"></div>
    </div>

    <!-- Summary -->
    <div class="grid cols-3">
      <div class="card">
        <h3>Summary</h3>
        <div class="kv">
          <div><b>Total Schemas</b> <span id="totalSchemas">0</span></div>
          <div><b>Validated Targets</b> <span id="matchedCount">0</span></div>
          <div><b>Avg Validation</b> <span id="avgValidation">0</span></div>
        </div>
        <div class="badges" id="matchedBadges"></div>
      </div>

      <div class="card">
        <h3>Validation</h3>
        <div class="kv">
          <div><b>Total Points</b> <span id="totalPoints">0</span></div>
          <div><b>Max Points</b> <span id="maxPoints">0</span></div>
          <div><b>Schemas Validated</b> <span id="schemasValidated">0</span></div>
        </div>
        <div>
          <span id="validationScorePill" class="score">0</span>
        </div>
      </div>

      <div class="card">
        <h3>Rich Results Eligibility</h3>
        <div id="eligibility" class="elig"></div>
      </div>
    </div>

    <!-- Area cards -->
    <div class="grid cols-3">

      <div class="card">
        <h3>robots.txt</h3>
        <div class="kv"><b>Score</b> <span id="robotsScore" class="score">0</span></div>
        <div id="robotsDetails" class="sub"></div>
        <div class="list" id="robotsIssues"></div>
        <div class="list" id="robotsRecs"></div>
      </div>

      <div class="card">
        <h3>llms.txt</h3>
        <div class="kv"><b>Score</b> <span id="llmScore" class="score">0</span></div>
        <div id="llmDetails" class="sub"></div>
        <div class="list" id="llmIssues"></div>
        <div class="list" id="llmRecs"></div>
      </div>

      <div class="card">
        <h3>ai.txt</h3>
        <div class="kv"><b>Score</b> <span id="aiScore" class="score">0</span></div>
        <div id="aiDetails" class="sub"></div>
        <div class="list" id="aiIssues"></div>
        <div class="list" id="aiRecs"></div>
      </div>

      <div class="card">
        <h3>OpenGraph / Twitter</h3>
        <div class="kv"><b>Score</b> <span id="ogScore" class="score">0</span></div>
        <div id="ogDetails" class="sub"></div>
        <div class="list" id="ogIssues"></div>
        <div class="list" id="ogRecs"></div>
      </div>

      <div class="card">
        <h3>Sitemap</h3>
        <div class="kv"><b>Score</b> <span id="smScore" class="score">0</span></div>
        <div id="smDetails" class="sub"></div>
        <div class="list" id="smIssues"></div>
        <div class="list" id="smRecs"></div>
      </div>

      <div class="card">
        <h3>Crawlability</h3>
        <div class="kv"><b>Score</b> <span id="crawlScore" class="score">0</span></div>
        <div id="crawlDetails" class="sub"></div>
        <div class="list" id="crawlIssues"></div>
        <div class="list" id="crawlRecs"></div>
      </div>

      <div class="card">
        <h3>Meta Consistency</h3>
        <div class="kv"><b>Score</b> <span id="metaScore" class="score">0</span></div>
        <div id="metaDetails" class="sub"></div>
        <div class="list" id="metaIssues"></div>
        <div class="list" id="metaRecs"></div>
      </div>

      <div class="card">
        <h3>Canonical / OG Alignment</h3>
        <div class="kv"><b>Score</b> <span id="canScore" class="score">0</span></div>
        <div id="canDetails" class="sub"></div>
        <div class="list" id="canIssues"></div>
        <div class="list" id="canRecs"></div>
      </div>

      <div class="card">
        <h3>Content Structure</h3>
        <div class="kv"><b>Score</b> <span id="contentScore" class="score">0</span></div>
        <div id="contentDetails" class="sub"></div>
        <div class="list" id="contentIssues"></div>
        <div class="list" id="contentRecs"></div>
      </div>

      <div class="card">
        <h3>Breadcrumbs</h3>
        <div class="kv"><b>Score</b> <span id="bcScore" class="score">0</span></div>
        <div id="bcDetails" class="sub"></div>
        <div class="list" id="bcIssues"></div>
        <div class="list" id="bcRecs"></div>
      </div>

      <div class="card">
        <h3>FAQ / HowTo (AEO)</h3>
        <div class="kv"><b>Score</b> <span id="faqScore" class="score">0</span></div>
        <div id="faqDetails" class="sub"></div>
        <div class="list" id="faqIssues"></div>
        <div class="list" id="faqRecs"></div>
      </div>

      <div class="card">
        <h3>Performance</h3>
        <div class="kv"><b>Score</b> <span id="perfScore" class="score">0</span></div>
        <div id="perfDetails" class="sub"></div>
        <div class="list" id="perfIssues"></div>
        <div class="list" id="perfRecs"></div>
      </div>
    </div>

    <!-- Schemas -->
    <div class="section-title">Schemas Found</div>
    <div id="schemasWrap" class="grid cols-2"></div>

  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const urlInput = $('#urlInput');
    const analyzeBtn = $('#analyzeBtn');
    const loading = $('#loading');
    const errorBox = $('#error');

    function scoreClass(v){
      if (v >= 85) return 'excellent';
      if (v >= 70) return 'good';
      if (v >= 45) return 'fair';
      return 'poor';
    }
    function htmlEscape(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;')
    }
    function cleanClone(obj){
      // Remove undefined / functions; keep JSON-serializable
      return JSON.parse(JSON.stringify(obj));
    }
    function jsonSyntaxHighlight(json){
      let s = htmlEscape(JSON.stringify(cleanClone(json), null, 2));
      // Keys
      s = s.replace(/(^|\n)\s*"(.*?)"\s*:/g, (m, a, b)=> `${a}<span class="k">"${b}"</span>:` );
      // Strings
      s = s.replace(/: "(.*?)"/g, (m, v)=> `: <span class="s">"${v}"</span>`);
      // Numbers
      s = s.replace(/: ([\-]?\d+(?:\.\d+)?)(,?)/g, (m, num, comma)=> `: <span class="n">${num}</span>${comma}`);
      // true/false/null
      s = s.replace(/: (true|false|null)/g, (m, b)=> `: <span class="b">${b}</span>`);
      return s;
    }
    function setScore(el, v){
      el.textContent = v;
      el.className = 'score ' + scoreClass(v);
    }
    function listInto(el, arr, cls){
      el.innerHTML = (arr||[]).map(t => `<div class="${cls}">${htmlEscape(t.message || t)}</div>`).join('');
    }
    function kv(...pairs){
      return pairs.filter(Boolean).map(([k,v])=>`<div><b>${htmlEscape(k)}</b> ${htmlEscape(v)}</div>`).join('');
    }
    function pill(text, href){
      if (href) return `<a class="pill docs" href="${href}" target="_blank" rel="noopener">${htmlEscape(text)} ⧉</a>`;
      return `<span class="pill">${htmlEscape(text)}</span>`;
    }

    analyzeBtn.addEventListener('click', analyze);
    urlInput.addEventListener('keypress', e => { if (e.key === 'Enter') analyze(); });

    async function analyze(){
      const url = urlInput.value.trim();
      if (!url){ errorBox.textContent = 'Please enter a URL.'; return; }
      errorBox.textContent = '';
      loading.style.display = 'block';
      analyzeBtn.disabled = true;

      try{
        const r = await fetch('/api/analyze',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url})});
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Analysis failed');
        renderAll(data);
      }catch(err){
        errorBox.textContent = err.message || 'Something went wrong.';
      }finally{
        loading.style.display = 'none';
        analyzeBtn.disabled = false;
      }
    }

    function renderAll(data){
      // Summary
      const totalSchemas = (data.jsonLd?.length||0) + (data.microdata?.length||0) + (data.rdfa?.length||0);
      $('#totalSchemas').textContent = totalSchemas;
      $('#matchedCount').textContent = data.validation?.schemaCount || 0;
      $('#avgValidation').textContent = data.validation?.averageScore || 0;
      $('#totalPoints').textContent = data.validation?.totalScore || 0;
      $('#maxPoints').textContent = data.validation?.totalMaxScore || 0;
      $('#schemasValidated').textContent = data.validation?.schemaCount || 0;
      setScore($('#validationScorePill'), data.validation?.averageScore || 0);

      // Matched badges
      const badges = (data.matched||[]).map(m => pill(`${m.type} • ${m.source}`, (m.validation?.schemaDocs||'')));
      $('#matchedBadges').innerHTML = badges.join('');

      // Eligibility
      const eligWrap = $('#eligibility');
      eligWrap.innerHTML = (data.richEligibility||[]).map(e => {
        const cls = e.eligible ? 'ok' : 'no';
        const title = e.eligible ? 'Eligible' : 'Needs work';
        const reasons = (e.reasons||[]).length ? ` — ${htmlEscape(e.reasons.join(', '))}` : '';
        return `<span class="badge ${cls}">${htmlEscape(e.feature)} • ${title}${reasons}</span>`;
      }).join('');

      // Area cards
      fillArea('robots', data.robotsAnalysis, (a)=> kv(['Exists', a.exists?'Yes':'No'], ['AI bots', (a.aiCrawlers||[]).join(', ')||'None'], ['Sitemap', a.sitemapFound ? a.sitemapUrl : 'Not declared']));
      fillArea('llm', data.llmAnalysis, (a)=> kv(['Exists', a.exists?'Yes':'No'], ['Quality', a.contentQuality||'none'], ['Sections', (a.sections||[]).length]));
      fillArea('ai', data.aiAnalysis, (a)=> kv(['Exists', a.exists?'Yes':'No'], ['AI bots', (a.aiCrawlers||[]).join(', ')||'None'], ['Attribution', a.attributionRequired?'Required':'—']));
      fillArea('og', data.openGraphAnalysis, (a)=> kv(['Exists', a.exists?'Yes':'No'], ['Social', (a.socialCoverage||[]).join(', ')||'None'], ['OG tags', Object.keys(a.tags||{}).length]));
      fillArea('sm', data.sitemapAnalysis, (a)=> kv(['Exists', a.exists?'Yes':'No'], ['XML', a.xmlValid?'Valid':'—'], ['URLs', a.urlCount||0], ['Images', a.hasImages?'Yes':'—']));
      fillArea('crawl', data.crawlability, (a)=> kv(['robots meta', a.details?.robotsMeta||'—'], ['internal links', a.details?.internalLinks||0], ['nofollow links', a.details?.nofollowLinks||0]));
      fillArea('meta', data.metaConsistency, (a)=> kv(['Title', a.details?.title||'—'], ['Schema name', a.details?.schemaName||'—']));
      fillArea('can', data.canonicalOgAlignment, (a)=> kv(['Canonical', a.details?.canonical||'—'], ['og:url', a.details?.ogUrl||'—']));
      fillArea('content', data.contentStructureAnalysis, (a)=> kv(['H1..H6', JSON.stringify(a.headerHierarchy||{})], ['Paragraphs', a.paragraphStats?.count||0], ['Readability', a.readabilityScore||0]));
      fillArea('bc', data.breadcrumbAnalysis, (a)=> kv(['Exists', a.exists?'Yes':'No'], ['Type', a.breadcrumbType||'—'], ['Depth', a.depth||0]));
      fillArea('faq', data.faqHowToAnalysis, (a)=> kv(['FAQ count', a.totalQuestions||0], ['HowTo steps', a.totalSteps||0], ['Snippet Potential', a.featuredSnippetPotential||'low']));
      fillArea('perf', data.performanceAnalysis, (a)=> kv(['Size', a.pageSpeed?.size||'—'], ['Requests', a.pageSpeed?.requests||0], ['Mobile', a.mobileFriendly?'Yes':'—'], ['LCP', a.coreWebVitals?.LCP?.value||'—']));

      // Schemas (clean preview + validation mapping)
      renderSchemas(data);
    }

    function fillArea(prefix, obj, detailsBuilder){
      const scoreEl = document.getElementById(prefix + 'Score');
      const detEl = document.getElementById(prefix + 'Details');
      const issuesEl = document.getElementById(prefix + 'Issues');
      const recsEl = document.getElementById(prefix + 'Recs');

      if (!obj){
        setScore(scoreEl, 0);
        detEl.innerHTML = '<span class="muted">No data.</span>';
        issuesEl.innerHTML = ''; recsEl.innerHTML = '';
        return;
      }
      setScore(scoreEl, obj.score||0);
      detEl.innerHTML = detailsBuilder(obj);
      listInto(issuesEl, obj.issues||[], 'issue');
      listInto(recsEl, obj.recommendations||[], 'rec');
    }

    function renderSchemas(data){
      const wrap = $('#schemasWrap');
      wrap.innerHTML = '';

      // Build a hash map for validation lookup by JSON string
      const vmap = new Map();
      (data.matched||[]).forEach(m => {
        const key = JSON.stringify(m.data);
        vmap.set(key, { validation: m.validation, schemaDocs: m.validation?.schemaDocs, type: m.type, source: m.source });
      });

      const blocks = [
        {label:'JSON-LD', list:data.jsonLd||[]},
        {label:'Microdata', list:data.microdata||[]},
        {label:'RDFa', list:data.rdfa||[]}
      ];

      blocks.forEach(block => {
        block.list.forEach((schemaObj, idx) => {
          const key = JSON.stringify(schemaObj);
          const v = vmap.get(key);
          const schemaType = Array.isArray(schemaObj['@type']) ? schemaObj['@type'].join(', ') : (schemaObj['@type'] || 'Thing');

          const item = document.createElement('div');
          item.className = 'schema-item';

          item.innerHTML = `
            <div class="schema-head">
              <div class="schema-info">
                ${pill(schemaType)}
                ${pill(block.label)}
                ${v ? `<span class="pill match">MATCH</span>` : ``}
                ${v?.schemaDocs ? `<a href="${v.schemaDocs}" target="_blank" class="pill docs">Schema docs ⧉</a>` : ``}
                ${v?.validation ? `<span class="score ${scoreClass(v.validation.score||0)}">${v.validation.score||0}/${v.validation.maxScore||100}</span>` : ``}
              </div>
              <div class="muted">Click to expand</div>
            </div>
            <div class="schema-body">
              ${v?.validation ? renderValidation(v.validation) : ''}
              <div class="hr"></div>
              <div class="pre-wrap json">
                <button class="copy">Copy</button>
                <pre class="json">${jsonSyntaxHighlight(schemaObj)}</pre>
              </div>
            </div>
          `;

          // toggle
          const head = item.querySelector('.schema-head');
          const body = item.querySelector('.schema-body');
          head.addEventListener('click', ()=>{ body.style.display = (body.style.display==='block'?'none':'block'); });

          // copy
          const copyBtn = item.querySelector('.copy');
          copyBtn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            const raw = JSON.stringify(cleanClone(schemaObj), null, 2);
            navigator.clipboard.writeText(raw).then(()=>{
              copyBtn.textContent = 'Copied!';
              setTimeout(()=> copyBtn.textContent='Copy', 900);
            });
          });

          wrap.appendChild(item);
        });
      });

      if (!wrap.childElementCount){
        wrap.innerHTML = `<div class="card"><div class="muted">No schema detected on this page.</div></div>`;
      }
    }

    function renderValidation(v){
      const issues = (v.issues||[]).map(it => `<div class="issue">${htmlEscape(it.message||String(it))}${it.docs?` — <a class="docs" href="${it.docs}" target="_blank">docs</a>`:''}</div>`).join('');
      const recs = (v.recommendations||[]).map(it => `<div class="rec">${htmlEscape(it.message||String(it))}${it.docs?` — <a class="docs" href="${it.docs}" target="_blank">docs</a>`:''}</div>`).join('');
      return `
        <div class="list">
          <div><b>Validation details</b></div>
          ${issues || '<div class="rec">✅ No blocking issues.</div>'}
          ${recs}
        </div>
      `;
    }

  </script>
</body>
</html>
